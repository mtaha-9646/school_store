name: Deploy to PythonAnywhere

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      # Add tests here if available
      # - name: Run Tests
      #   run: python -m pytest

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Webhook Deployment
        if: success()
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }} # e.g. https://your-app.pythonanywhere.com
          DEPLOY_SECRET: ${{ secrets.DEPLOY_SECRET }}
        run: |
          if [ -z "$DEPLOY_HOST" ]; then
            echo "DEPLOY_HOST secret not set. Skipping webhook trigger."
          else
            echo "Triggering deployment at $DEPLOY_HOST..."
            curl -X POST "$DEPLOY_HOST/api/deploy_trigger" \
              -H "X-Deploy-Secret: $DEPLOY_SECRET" \
              --fail
          fi
